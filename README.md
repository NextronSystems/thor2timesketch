# THOR to Timesketch Mapper

This utility simplifies the process of importing THOR logs into Timesketch, enabling cybersecurity analysts to enhance detection and analysis of malicious activity by combining THOR findings on a shared timeline.

## Description

The tool processes THOR JSON logs and maps them to Timesketch’s required timeline format by:

* Extracting relevant fields from THOR logs.
* Generating entries with the required Timesketch fields: `message`, `datetime`, and `timestamp_desc`.
* Handling THOR events with multiple timestamps by duplicating log entries for each timestamp found.

## Field Mapping Logic

The following fields are mapped from THOR logs to Timesketch's required format:

* **message**: Key detection details generated by THOR, providing context or justification for the event.
* **datetime**:
    * The THOR scan execution time, or
    * A timestamp found within the specific event related to a module or feature.
* **timestamp_desc**:
    * If `datetime` refers to the THOR scan start time → `"Timestamp of THOR scan execution"`.
    * If `datetime` originates from a specific module field → `"ModuleName - FieldName"` (e.g., `Filescan - modified`).

**Note**: The **ruledate** field is not mapped to `datetime`.

This utility supports THOR JSON log format v2 and is designed with forward compatibility for JSON log format v3.

## Features

1. Validates and reads the input THOR JSON file.
2. Flattens THOR logs for efficient indexing and searching.
3. Identifies the THOR log version and selects the appropriate mapper.
4. Extracts relevant information and timestamps from each log entry.
5. Maps THOR fields to Timesketch's required format (`message`, `datetime`, `timestamp_desc`).
6. Writes the mapped events to a single JSONL output file.
7. The resulting `.jsonl` file can be ingested into Timesketch using either the Web UI or the [Importer CLI tool](https://timesketch.org/guides/user/cli-client/).

## Installation - macOS/Linux

### Prerequisites

Ensure the following are installed on your system:

* [Git](https://git-scm.com/downloads)
* [Python 3.9](https://www.python.org/downloads/) or higher
* [THOR](https://www.nextron-systems.com/thor/) JSON logs (v2 or v3)

### Steps

1. Clone the repository:
     ```bash
     git clone https://github.com/NextronSystems/thor-ts-mapper.git
     cd thor-ts-mapper
     ```
2. Make the installation script executable:
     ```bash
     chmod u+x install_thor2ts.sh
     ```
3. Install thor2ts:
     ```bash
     . install_thor2ts.sh
     ```
     This script will:
     * Check for prerequisites.
     * Clone or update the repository.
     * Create and activate a virtual environment (`venv-thor2ts`).
     * Install the package in editable mode.
     * Test the installation by running `thor2ts --version`.

4. For future use, activate the virtual environment:
     ```bash
     source /path/to/thor-ts-mapper/venv-thor2ts/bin/activate
     ```

## Usage

Once the virtual environment is active, use the tool to convert THOR logs:

```bash
thor2ts <input_file> -o <output_file>
```

### Arguments

* `input_file`: Path to the THOR JSON file to convert (required).
    #### Example:
    ```bash
    thor2ts thor_scan.json
    ```
* `-o output_file`: Output file path (optional, default: `<input_file_name>_mapped.jsonl`).
    #### Example:
    ```bash
    thor2ts thor_scan.json -o /path/to/output/thor2timesketch.jsonl
    ```
* `-v, --verbose`: Enable verbose output (optional).
    #### Example:
    ```bash
    thor2ts thor_scan.json -v
    ```
* `--version`: Show the version of the tool and exit (optional).
    #### Example:
    ```bash
    thor2ts --version
    ```

## Input Files

THOR scan log files (`.json`) in log version **v2** or **v3**.

## Output Files

The tool converts THOR JSON logs to Timesketch-compatible format. If no output file is specified, the output will be written to the same location as the input file with `"<input_file_name>_mapped.jsonl"` appended.

## Warning

The mapped file extension must end with `.jsonl` for successful ingestion into Timesketch. Files with other extensions (e.g., `.json`) may cause the import to fail.

## Ingesting into Timesketch

After conversion, the resulting `.jsonl` file can be ingested into Timesketch using either the Web UI or the `tsctl` [Importer CLI tool](https://timesketch.org/guides/user/cli-client/).

## Contributing

Contributions are welcome! To contribute:

1. Fork the repository.
2. Create a feature branch.
3. Submit a pull request with your improvements or bug fixes.

## Support

If you encounter any issues or have questions, please open an issue in the GitHub repository.